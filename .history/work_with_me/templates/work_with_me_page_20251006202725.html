{% extends "base.html" %}
{% load static wagtailcore_tags wagtailimages_tags form_extras wme_qr %}
{% load i18n %}

{% block title %}{{ page.seo_title|default:page.title }}{% endblock %}
{% block meta_description %}{{ page.search_description }}{% endblock %}

{% block body_class %}template-work-with-me{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'css/work_with_me.css' %}">
  <link rel="stylesheet" href="{% static 'css/journalism.css' %}">
{% endblock extra_css %}

{% block content %}
<div class="container-fluid py-2">
  <div class="row">
    <!-- ================= LEFT: hero + copy + form (col-8) ================= -->
    <div class="col-12 col-lg-8">

      <!-- Hero ribbon -->
      <div class="written-hero mb-3">
        <span class="cap" aria-hidden="true"></span>
        <div class="block-title" style="color:#73f0fa">
          {{ page.greeting|default:"Work with me" }}
        </div>
      </div>

      <!-- Optional sub-head -->
      <h3 class="section-title"><span>15 years of impactful storytelling</span></h3>

      {% if page.intro %}<div class="mb-3">{{ page.intro|richtext }}</div>{% endif %}
      {% if page.bold_text %}<p class="bold_text">{{ page.bold_text|richtext }}</p>{% endif %}

      <!-- Form -->
      <h3 id="contact" class="section-title mt-4"><span>Letâ€™s talk</span></h3>

      <form action="{% pageurl page %}" method="post" novalidate>
        {% csrf_token %}

        {% if form.non_field_errors %}
          <div class="alert alert-danger" role="alert">
            {{ form.non_field_errors }}
          </div>
        {% endif %}

        <!-- First 3 fields in a row (Name / Surname / Email) -->
        <div class="row g-3">
          {% for field in form.visible_fields %}
            {% if forloop.counter0 < 3 %}
              <div class="col-12 col-md-4">
                {% include "work_with_me/_field.html" with field=field rows=1 %}
              </div>
            {% endif %}
          {% endfor %}
        </div>

        <!-- Remaining non-textarea fields -->
        {% for field in form.visible_fields %}
          {% if forloop.counter0 >= 3 and field.field.widget.input_type != 'textarea' %}
            <div class="mt-3">
              {% include "work_with_me/_field.html" with field=field %}
            </div>
          {% endif %}
        {% endfor %}

        <!-- Message textarea -->
        {% for field in form.visible_fields %}
          {% if field.field.widget.input_type == 'textarea' %}
            <div class="mt-3">
              {% include "work_with_me/_field.html" with field=field rows=8 %}
            </div>
          {% endif %}
        {% endfor %}

        {% for hf in form.hidden_fields %}{{ hf }}{% endfor %}

        <div class="d-flex justify-content-end mt-2">
          <button class="btn btn-brand px-4" type="submit">Send</button>
        </div>
      </form>

    </div><!-- /col-8 -->

    <!-- ================= RIGHT: sidebar (col-4) ================= -->
    <div class="col-12 col-lg-4 mt-4 mt-lg-0">
      <aside class="bts-aside contact_aside">

        {% if page.portrait %}
          <div class="wme-portrait mb-3">
            {% image page.portrait fill-720x900 class="img-fluid w-100" loading="lazy" decoding="async" alt="Portrait" %}
          </div>
        {% endif %}

        {# QR SECTION #}
        <h3 class="section-title qr-title"><span>{% trans "Scan the QR code or see below" %}</span></h3>

        <div class="mb-3 wme-center">
          {% wme_qr_svg page.get_qr_payload page.qr_scale as qr_svg %}
          {% if qr_svg %}
            {# Clickable QR â€” scanners read the URL; desktop users can click #}
            <a class="wme-qr mb-2 d-inline-block"
              href="{{ page.get_qr_payload }}"
              aria-label="{% trans 'Open contact card' %}">
              {{ qr_svg|safe }}
              <span class="visually-hidden">{% trans "Open contact card" %}</span>
            </a>

            <p class="mb-3">
              {% if page.vcard_file %}
                {# Direct Cloudinary download (forces attachment) #}
                <a class="btn btn-brand-outline btn-sm wme-vcard"
                  href="{{ page.vcard_file.url }}?fl_attachment={{ page.slug|default:'contact'|slugify }}.vcf"
                  download>
                  {% trans "Download vCard (.vcf)" %}
                </a>
              {% else %}
                {# Fallback: same inline endpoint but force download via ?download=1 #}
                <a class="btn btn-brand-outline btn-sm wme-vcard"
                  href="{% url 'work_with_me:vcard_inline' page.id %}?download=1">
                  {% trans "Download vCard (.vcf)" %}
                </a>
              {% endif %}
            </p>

            <noscript>
              <p><a href="{{ page.get_qr_payload }}">{% trans "Open contact card" %}</a></p>
            </noscript>
          {% else %}
            <p class="text-muted small mb-2">{% trans "QR code not available." %}</p>
          {% endif %}
        </div>
        {# CONTACT DETAILS #}
        <ul class="list-unstyled small wme-contacts">
          {% if page.phone_number %}
            <li class="mb-2">
              <span class="wme-ico" aria-hidden="true">ðŸ“ž</span>
              <a href="tel:{{ page.phone_number|cut:' ' }}">{{ page.phone_number }}</a>
            </li>
          {% endif %}
          {% if page.contact_email or page.to_address %}
            <li class="mb-2">
              <span class="wme-ico" aria-hidden="true">@</span>
              <a href="mailto:{% firstof page.contact_email page.to_address %}">
                {% firstof page.contact_email page.to_address %}
              </a>
            </li>
          {% endif %}
        </ul>

      </aside>
    </div><!-- /col-4 -->
  </div><!-- /row -->
</div><!-- /container-fluid -->
{% endblock %}
