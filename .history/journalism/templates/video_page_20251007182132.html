{% extends "base.html" %}
{% load static i18n wagtailcore_tags wagtailembeds_tags wagtailimages_tags bts_tags %}

{% block body_class %}template-video{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'css/journalism.css' %}">
{% endblock extra_css %}

{% block content %}
<section class="container-fluid py-4">
  <div class="row">
    {# ================= LEFT: HERO + INTRO + FEATURED + GRID ================= #}
    <div class="col-12 col-lg-8">

      {# HERO / INTRO #}
      <div class="video-hero mb-3">
        <span class="cap" aria-hidden="true"></span>
        <div class="block-title" style="color: #73f0fa">{% trans "As a multimedia Journalist I also do Videos" %}</div>
        <p>{% trans "For some clients, I had to film and produce videos. Hereâ€™s a glimpse at my multimedia work." %}</p>
      </div>

      {% if page.intro %}
        <div class="mb-3">{{ page.intro|richtext }}</div>
      {% endif %}

      {# ===== FEATURED PLAYER ===== #}
      {% if featured %}
        <section class="featured mb-1">
          <h2 class="section-title"><span>{% trans "Selected Episode" %}</span></h2>

          <div class="featured__grid">
            <div class="featured__media">
              <div id="video-player" class="embed" aria-live="polite">
                {% embed featured.embed_url %}
              </div>
            </div>

            <aside class="featured__meta">
              <p class="meta__date" id="meta-date">{{ featured.video_date|date:"d/m/Y" }}</p>
              <h3 class="meta__title" id="meta-title">{{ featured.standfirst|default:_("Untitled") }}</h3>

              {% if featured.description %}
                <div class="meta__body richtext" id="meta-desc">{{ featured.description|richtext }}</div>
              {% else %}
                <div class="meta__body richtext" id="meta-desc"></div>
              {% endif %}

              <div class="meta__credits" id="meta-credits">
                {% if featured.produced_by and featured.produced_for %}
                  {% blocktrans with by=featured.produced_by forw=featured.produced_for %}
                    Produced by <strong>{{ by }}</strong> for: <strong>{{ forw }}</strong>
                  {% endblocktrans %}
                {% elif featured.produced_by %}
                  {% blocktrans with by=featured.produced_by %}
                    Produced by <strong>{{ by }}</strong>
                  {% endblocktrans %}
                {% elif featured.produced_for %}
                  {% blocktrans with forw=featured.produced_for %}
                    Produced for: <strong>{{ forw }}</strong>
                  {% endblocktrans %}
                {% endif %}
              </div>

              {# --- Share row --- #}
              <div class="meta__share">
                <span>{% trans "Share it" %}</span>
                <a aria-label="{% trans 'Share to LinkedIn' %}"
                   href="https://www.linkedin.com/sharing/share-offsite/?url={{ request.build_absolute_uri|urlencode }}"
                   target="_blank" rel="noopener">{% trans "LinkedIn" %}</a>
                <a aria-label="{% trans 'Share to WhatsApp' %}"
                    href="https://api.whatsapp.com/send?text={{ request.build_absolute_uri|urlencode }}"
                    target="_blank" rel="noopener">{% trans "WhatsApp" %}</a>
                <a aria-label="{% trans 'Share to Bluesky' %}"
                   href="https://bsky.app/intent/compose?text={{ featured.standfirst|default:_('Untitled')|urlencode }}%20{{ request.build_absolute_uri|urlencode }}"
                   target="_blank" rel="noopener">{% trans "Bluesky" %}</a>
                <a aria-label="{% trans 'Share to Line' %}"
                   href="https://social-plugins.line.me/lineit/share?url={{ request.build_absolute_uri|urlencode }}"
                   target="_blank" rel="noopener">{% trans "Line" %}</a>
              </div>

              {% if featured.external_url %}
                <a class="btn" id="meta-link" href="{{ featured.external_url }}" target="_blank" rel="noopener">{% trans "Open video" %}</a>
              {% else %}
                <a class="btn disabled" id="meta-link" tabindex="-1" aria-disabled="true">{% trans "Open video" %}</a>
              {% endif %}
            </aside>
          </div>

          {# Stash current featured embed + meta for swap-back #}
          <template id="tpl-featured-current">{% embed featured.embed_url %}</template>
          <div id="featured-meta-store"
               data-title="{{ featured.standfirst|default:_('Untitled')|escape }}"
               data-date="{{ featured.video_date|date:'d/m/Y' }}"
               data-produced-by="{{ featured.produced_by|default_if_none:''|escape }}"
               data-produced-for="{{ featured.produced_for|default_if_none:''|escape }}"
               data-external-url="{{ featured.external_url|default_if_none:''|escape }}"
               hidden></div>
        </section>
      {% endif %}

      {# ===== ALL VIDEOS GRID ===== #}
      <section class="all-videos">
        <h2 class="section-title"><span>{% trans "All my videos" %}</span></h2>

        <div class="cards" id="video-cards">
          {% for v in videos %}
            <article class="card">
              <button
                class="card__media play-in-hero"
                type="button"
                aria-label="{% blocktrans with t=v.standfirst|default:_('Untitled') %}Play {{ t }} in player{% endblocktrans %}"
                data-title="{{ v.standfirst|default:_('Untitled')|escape }}"
                data-date="{{ v.video_date|date:'d/m/Y' }}"
                data-produced-by="{{ v.produced_by|default_if_none:''|escape }}"
                data-produced-for="{{ v.produced_for|default_if_none:''|escape }}"
                data-external-url="{{ v.external_url|default_if_none:''|escape }}"
                data-tpl-id="tpl-{{ forloop.counter0 }}"
              >
                <div class="embed embed--thumb">{% embed v.embed_url %}</div>
              </button>

              <div class="card__body">
                <h3 class="card__title">
                  <button
                    class="link-unstyled play-in-hero"
                    type="button"
                    data-title="{{ v.standfirst|default:_('Untitled')|escape }}"
                    data-date="{{ v.video_date|date:'d/m/Y' }}"
                    data-produced-by="{{ v.produced_by|default_if_none:''|escape }}"
                    data-produced-for="{{ v.produced_for|default_if_none:''|escape }}"
                    data-external-url="{{ v.external_url|default_if_none:''|escape }}"
                    data-tpl-id="tpl-{{ forloop.counter0 }}"
                  >
                    {{ v.standfirst|default:_("Untitled") }}
                  </button>
                </h3>
                {% if v.standfirst %}<p class="card__dek">{{ v.standfirst }}</p>{% endif %}
              </div>

              <template id="tpl-{{ forloop.counter0 }}">
                {% embed v.embed_url %}
              </template>
            </article>
          {% empty %}
            <p class="text-muted m-0">{% trans "No videos yet." %}</p>
          {% endfor %}
        </div>
      </section>

    </div>

    {# ================= RIGHT: BTS SIDEBAR ================= #}
    <div class="col-12 col-lg-4 mt-4 mt-lg-0">
      <aside class="bts-aside">
        <h3 class="section-title"><span>{% trans "Behind the Scenes" %}</span></h3>

        {% bts_teasers_for 'video' 3 as bts_teasers %}
        {% if bts_teasers %}
          <ul class="list-unstyled">
            {% for bts in bts_teasers %}
              <li class="mb-3">
                <article class="bts-card bts-card--sidebar">
                  <a href="{{ bts.url }}" class="thumb">
                    {% if bts.teaser_image %}
                      {% image bts.teaser_image fill-600x338 class="w-100" loading="lazy" decoding="async" alt=bts.card_title %}
                    {% endif %}
                    <span class="bts-title">{{ bts.card_title }}</span>
                  </a>
                  <div class="bts-body">
                    {% if bts.card_summary %}<p class="bts-text">{{ bts.card_summary }}</p>{% endif %}
                    <a href="{{ bts.url }}" class="bts-cta">{% trans "Discover how it happened!" %}</a>
                  </div>
                </article>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <p class="text-muted">{% trans "More behind-the-scenes coming soon." %}</p>
        {% endif %}
      </aside>
    </div>
  </div>
</section>

{# Lazy-load embeds + player swap logic #}
<script>
  // Add lazy to iframes created by wagtail-embed
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('iframe').forEach(f => f.setAttribute('loading', 'lazy'));
  });

  (function () {
    const player      = document.getElementById('video-player');
    const metaTitle   = document.getElementById('meta-title');
    const metaDate    = document.getElementById('meta-date');
    const metaDesc    = document.getElementById('meta-desc');
    const metaCredits = document.getElementById('meta-credits');
    const metaLink    = document.getElementById('meta-link');

    const featuredTpl   = document.getElementById('tpl-featured-current');
    const featuredStore = document.getElementById('featured-meta-store');

    let prevFeatured = {
      embedHTML:   featuredTpl ? featuredTpl.innerHTML : '',
      title:       featuredStore ? featuredStore.dataset.title : '',
      date:        featuredStore ? featuredStore.dataset.date : '',
      producedBy:  featuredStore ? featuredStore.dataset.producedBy : '',
      producedFor: featuredStore ? featuredStore.dataset.producedFor : '',
      externalUrl: featuredStore ? featuredStore.dataset.externalUrl : ''
    };

    function setHTML(el, html) { if (el) el.innerHTML = html || ''; }
    function setCredits(by, forWho) {
      if (!metaCredits) return;
      if (by && forWho) {
        metaCredits.innerHTML = `{{ _("Produced by") }} <strong>${by}</strong> {{ _("for:") }} <strong>${forWho}</strong>`;
      } else if (by) {
        metaCredits.innerHTML = `{{ _("Produced by") }} <strong>${by}</strong>`;
      } else if (forWho) {
        metaCredits.innerHTML = `{{ _("Produced for:") }} <strong>${forWho}</strong>`;
      } else {
        metaCredits.innerHTML = '';
      }
    }
    function setLink(url) {
      if (!metaLink) return;
      if (url) {
        metaLink.classList.remove('disabled');
        metaLink.setAttribute('href', url);
        metaLink.setAttribute('aria-disabled', 'false');
        metaLink.removeAttribute('tabindex');
      } else {
        metaLink.classList.add('disabled');
        metaLink.removeAttribute('href');
        metaLink.setAttribute('aria-disabled', 'true');
        metaLink.setAttribute('tabindex', '-1');
      }
    }

    function updateCardButtons(cardEl, data) {
      const buttons = cardEl.querySelectorAll('.play-in-hero');
      buttons.forEach(btn => {
        btn.setAttribute('data-title', data.title || '{{ _("Untitled") }}');
        btn.setAttribute('data-date', data.date || '');
        btn.setAttribute('data-produced-by', data.producedBy || '');
        btn.setAttribute('data-produced-for', data.producedFor || '');
        btn.setAttribute('data-external-url', data.externalUrl || '');
      });
      const titleBtn = cardEl.querySelector('.card__title .play-in-hero');
      if (titleBtn) titleBtn.textContent = data.title || '{{ _("Untitled") }}';
      const dek = cardEl.querySelector('.card__dek');
      if (dek) dek.textContent = data.title || '';
    }

    document.addEventListener('click', function (e) {
      const btn = e.target.closest('.play-in-hero');
      if (!btn) return;

      const card = btn.closest('.card');
      const tplId = btn.getAttribute('data-tpl-id');
      const tpl = tplId ? document.getElementById(tplId) : null;
      const cardThumb = card ? card.querySelector('.embed.embed--thumb') : null;

      if (!tpl || !player || !card) return;

      const clicked = {
        embedHTML:   tpl.innerHTML,
        title:       btn.getAttribute('data-title') || '{{ _("Untitled") }}',
        date:        btn.getAttribute('data-date') || '',
        producedBy:  btn.getAttribute('data-produced-by') || '',
        producedFor: btn.getAttribute('data-produced-for') || '',
        externalUrl: btn.getAttribute('data-external-url') || ''
      };

      // Promote clicked to featured
      player.innerHTML = clicked.embedHTML;
      setHTML(metaTitle, clicked.title);
      setHTML(metaDate,  clicked.date);
      setHTML(metaDesc,  '');  // no per-card desc stored here
      setCredits(clicked.producedBy, clicked.producedFor);
      setLink(clicked.externalUrl);

      // Demote previous featured back into clicked card
      if (cardThumb && prevFeatured.embedHTML) {
        cardThumb.innerHTML = prevFeatured.embedHTML;
      }
      tpl.innerHTML = prevFeatured.embedHTML;
      updateCardButtons(card, prevFeatured);

      // New "previous" is the one we just promoted
      prevFeatured = clicked;

      player.scrollIntoView({ behavior: 'smooth', block: 'start' });
    });
  })();
</script>
{% endblock %}
