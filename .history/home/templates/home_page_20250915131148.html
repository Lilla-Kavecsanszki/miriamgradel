{% extends "base.html" %}
{% load static wagtailimages_tags wagtailcore_tags %}

{% block body_class %}template-homepage{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/journalism.css' %}">
<link rel="stylesheet" href="{% static 'css/home.css' %}">
{% endblock extra_css %}

{% block content %}
<div class="container-fluid py-4">
  <div class="octopus-bg mt-4 mb-4">
    <h1 class="octopus">NOT YOUR AVERAGE OCTOPUS</h1>
  </div>
  <!-- TOP -->
  <div class="home-hero mb-3">
    <span class="cap" aria-hidden="true"></span>
    <div class="block-title" style="color: #73f0fa">{{ page.intro_text|richtext }}
    </div>
  </div>

  {% if page.mission_statement %}
    <h3 class="section-title"><span>{{ page.mission_statement|richtext|striptags }}</span></h3>
  {% endif %}

  <!-- ========== SERVICES (Horizontal carousel) ========== -->
  <section id="services" class="mb-4">
    <h3 class="section-title"><span>Services</span></h3>

    <div class="hscroll" id="services-scroll">
      <!-- Minimal arrows -->
      <button class="hscroll__btn hscroll__btn--prev" aria-label="Previous services" type="button">‹</button>

      <div class="hscroll__track" tabindex="0" aria-label="Services carousel">
        {% for block in page.services %}
          {% if block.block_type == "service" %}
            <article class="service-card hscroll__item">
              <div class="service-card__img">
                {% image block.value.image fill-600x400 class="w-100 h-100" loading="lazy" decoding="async" %}
              </div>
              <div class="service-card__body">
                <h4 class="service-card__title">{{ block.value.title }}</h4>
                <p class="service-card__text">{{ block.value.description }}</p>
              </div>
            </article>
          {% endif %}
        {% empty %}
          <p class="text-muted m-0">Services coming soon.</p>
        {% endfor %}
      </div>

      <button class="hscroll__btn hscroll__btn--next" aria-label="Next services" type="button">›</button>

      <!-- dots (will be filled dynamically if more than 4 items) -->
      <div class="hscroll__dots" aria-label="Services navigation"></div>
    </div>
  </section>

  <!-- ========== REVIEWS ========== -->
  {% if page.reviews %}
  <section id="reviews" class="mb-4">
    <h3 class="section-title mb-4"><span>With so many impactful projects I have some references</span></h3>
    <div class="row g-3">
      {% for block in page.reviews %}
        {% if block.block_type == "review" %}
          <div class="col-12 col-lg-6 col-xxl-4">
            <article class="review-card h-100">
              {% if block.value.image %}
                <div class="review-card__img">
                  {% image block.value.image fill-400x400 class="w-100 h-100" loading="lazy" decoding="async" %}
                </div>
              {% endif %}
              <div class="review-card__body">
                <blockquote class="review-card__quote">“{{ block.value.quote }}”</blockquote>
                <div class="review-card__meta">
                  <div class="review-card__name">{{ block.value.name }}</div>
                  {% if block.value.role %}<div class="review-card__role">{{ block.value.role }}</div>{% endif %}
                </div>
              </div>
            </article>
          </div>
        {% endif %}
      {% endfor %}
    </div>
  </section>
  {% endif %}

{# ========== ABOUT (StreamField) ========== #}
{% if page.about %}
<section id="about" class="mb-4">
  <h3 class="section-title"><span>Want to know more about me?</span></h3>

  <div class="about-content">
    {% for blk in page.about %}
      {% if blk.block_type == "about_item" %}
        <article class="about-item">
          {% if blk.value.title %}
            <h4 class="about-subtitle">{{ blk.value.title }}</h4>
          {% endif %}
          <div class="about-text">
            {{ blk.value.body|richtext }}
          </div>
        </article>
      {% endif %}
    {% endfor %}
  </div>
</section>
{% endif %}

<!-- ========== CTA STRIP ========== -->
<section id="cta" class="cta-strip mt-5">
  <div class="cta-inner">
    <p class="cta-text m-0 me-3">You have a project in mind?</p>
    <a href="/work-with-me/" class="cta-btn">Let’s talk</a>
  </div>
</section>


<!-- Helper for the carousel buttons -->
<script>
(function () {
  const scroller = document.querySelector('#services-scroll');
  if (!scroller) return;

  const track = scroller.querySelector('.hscroll__track');
  const prev  = scroller.querySelector('.hscroll__btn--prev');
  const next  = scroller.querySelector('.hscroll__btn--next');
  const dotsContainer = scroller.querySelector('.hscroll__dots');

  const items = Array.from(track.querySelectorAll('.hscroll__item'));

  // create dots based on item count
  items.forEach((_, i) => {
    const dot = document.createElement('span');
    dot.className = 'hscroll__dot' + (i === 0 ? ' active' : '');
    dot.addEventListener('click', () => {
      track.scrollTo({
        left: items[i].offsetLeft - track.offsetLeft,
        behavior: 'smooth'
      });
    });
    dotsContainer.appendChild(dot);
  });

  const dots = Array.from(dotsContainer.querySelectorAll('.hscroll__dot'));

  function itemStep() {
    const item = items[0];
    const gap = parseFloat(getComputedStyle(track).gap) || 0;
    return item ? item.getBoundingClientRect().width + gap : 300;
  }

  prev.addEventListener('click', () =>
    track.scrollBy({ left: -itemStep(), behavior: 'smooth' })
  );
  next.addEventListener('click', () =>
    track.scrollBy({ left:  itemStep(), behavior: 'smooth' })
  );

  // update active dot on scroll
  track.addEventListener('scroll', () => {
    const scrollLeft = track.scrollLeft;
    let index = Math.round(scrollLeft / itemStep());
    if (index < 0) index = 0;
    if (index >= items.length) index = items.length - 1;
    dots.forEach((d, i) => d.classList.toggle('active', i === index));
  });
})();
</script>
{% endblock %}
