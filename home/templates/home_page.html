{% extends "base.html" %}
{% load static wagtailimages_tags wagtailcore_tags i18n %}

{% block body_class %}template-homepage{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'css/journalism.css' %}">
  <link rel="stylesheet" href="{% static 'css/home.css' %}">
{% endblock extra_css %}

{% block content %}
<div class="container-fluid">

  <!-- Octopus headline -->
  <div class="octopus-bg mt-4 mb-4">
    <h1 class="octopus" aria-label="{% trans 'Not your average octopus' %}">
      <span class="octo-line from-left">{% trans "Not Your" %}</span>
      <span class="octo-line from-right">{% trans "Average" %}</span>
      <span class="octo-line from-left">{% trans "Octopus" %}</span>
    </h1>
  </div>

  <!-- Intro ribbon -->
  <div class="home-hero mb-3">
    <span class="cap" aria-hidden="true"></span>
    <div class="block-title" style="color: #73f0fa">
      {{ page.intro_text|richtext }}
    </div>
  </div>

  {% if page.mission_statement %}
    <h3 class="section-title">
      <span>{{ page.mission_statement|richtext|striptags }}</span>
    </h3>
  {% endif %}

<!-- ========== SERVICES (Horizontal carousel) ========== -->
<section id="services" class="mb-4">
  <h3 class="section-title"><span>{% trans "Discover what I do" %}</span></h3>

  <div class="hscroll" id="services-scroll">
    <div class="hscroll__track" tabindex="0" aria-label="{% trans 'Services carousel' %}">
      {% for block in page.services %}
        {% if block.block_type == "service" %}
          {# Pick link target: internal page URL, else external URL, else # #}
          {% firstof block.value.link_page.url block.value.link_url "#" as base_href %}

          <a
            class="service-card hscroll__item text-decoration-none"
            href="{{ base_href }}{% if block.value.anchor %}#{{ block.value.anchor|slugify }}{% endif %}"
            aria-label="{{ block.value.title }}"
            {% if block.value.link_url and not block.value.link_page %}target="_blank" rel="noopener"{% endif %}
          >
            <div class="service-card__img">
              {% if block.value.image %}
                {% image block.value.image fill-600x400 class="w-100 h-100" loading="lazy" decoding="async" alt=block.value.title %}
              {% endif %}
            </div>
            <div class="service-card__body">
              <h4 class="service-card__title">{{ block.value.title }}</h4>
              {% if block.value.description %}
                <p class="service-card__text">{{ block.value.description }}</p>
              {% endif %}
            </div>
          </a>
        {% endif %}
      {% empty %}
        <p class="text-muted m-0">{% trans "Services coming soon." %}</p>
      {% endfor %}
    </div>

    <!-- Controls (inside .hscroll and after the track) -->
    <div class="hscroll__controls" aria-label="{% trans 'Carousel controls' %}">
      <button class="hscroll__btn hscroll__btn--prev" aria-label="{% trans 'Previous services' %}" type="button"></button>
      <div class="hscroll__dots" aria-label="{% trans 'Services navigation' %}"></div>
      <button class="hscroll__btn hscroll__btn--next" aria-label="{% trans 'Next services' %}" type="button"></button>
    </div>
  </div>
</section>

  <!-- ========== REVIEWS ========== -->
  {% if page.reviews %}
    <section id="reviews" class="mb-4">
      <h3 class="section-title mb-4">
        <span>{% trans "What working with me is like" %}</span>
      </h3>
      <div class="row g-3">
        {% for block in page.reviews %}
          {% if block.block_type == "review" %}
            <div class="col-12 col-lg-6 col-xxl-4">
              <article class="review-card h-100">
                {% if block.value.image %}
                  <div class="review-card__img">
                    {% image block.value.image fill-400x400 class="w-100 h-100" loading="lazy" decoding="async" alt=block.value.name %}
                  </div>
                {% endif %}
                <div class="review-card__body">
                  {% if block.value.quote %}
                    <blockquote class="review-card__quote">“{{ block.value.quote }}”</blockquote>
                  {% endif %}
                  <div class="review-card__meta">
                    <div class="review-card__name">{{ block.value.name }}</div>
                    {% if block.value.role %}
                      <div class="review-card__role">{{ block.value.role }}</div>
                    {% endif %}
                  </div>
                </div>
              </article>
            </div>
          {% endif %}
        {% endfor %}
      </div>
    </section>
  {% endif %}

  {# ========== ABOUT (two-column) ========== #}
  {% if page.about %}
    <section id="about" class="mb-4">
      <h3 class="section-title"><span>{% trans "Who is Miriam?" %}</span></h3>

      <div class="about-layout">
        <!-- LEFT: text -->
        <div class="about-content">
          {% for blk in page.about %}
            {% if blk.block_type == "about_item" %}
              <article class="about-item">
                {% if blk.value.title %}
                  <h4 class="about-subtitle">{{ blk.value.title }}</h4>
                {% endif %}
                <div class="about-text">
                  {{ blk.value.body|richtext }}
                </div>
              </article>
            {% endif %}
          {% endfor %}
        </div>

        <!-- RIGHT: photo -->
        {% if page.about_image %}
          <aside class="about-photo">
            <figure class="about-photo__frame">
              {% image page.about_image fill-720x880 class="w-100 h-auto" loading="lazy" decoding="async" alt=page.title %}
            </figure>
          </aside>
        {% endif %}
      </div>
    </section>
  {% endif %}

  <!-- Octopus animation -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const el = document.querySelector('.octopus');
      if (!el) return;
      const io = new IntersectionObserver(entries => {
        entries.forEach(e => {
          if (e.isIntersecting) { el.classList.add('in-view'); io.disconnect(); }
        });
      }, { threshold: 0.4 });
      io.observe(el);
    });
  </script>

  <!-- Services carousel helper -->
  <script>
  (function () {
    const scroller = document.querySelector('#services-scroll');
    if (!scroller) return;

    const track = scroller.querySelector('.hscroll__track');
    const prev  = scroller.querySelector('.hscroll__btn--prev');
    const next  = scroller.querySelector('.hscroll__btn--next');
    const dotsContainer = scroller.querySelector('.hscroll__dots');
    const items = Array.from(track.querySelectorAll('.hscroll__item'));

    // dots
    items.forEach((_, i) => {
      const dot = document.createElement('span');
      dot.className = 'hscroll__dot' + (i === 0 ? ' active' : '');
      dot.addEventListener('click', () => {
        track.scrollTo({ left: items[i].offsetLeft - track.offsetLeft, behavior: 'smooth' });
      });
      dotsContainer.appendChild(dot);
    });
    const dots = Array.from(dotsContainer.querySelectorAll('.hscroll__dot'));

    // step size
    function itemStep() {
      const item = items[0];
      const gap = parseFloat(getComputedStyle(track).gap) || 0;
      return item ? item.getBoundingClientRect().width + gap : 300;
    }

    prev.addEventListener('click', () => track.scrollBy({ left: -itemStep(), behavior: 'smooth' }));
    next.addEventListener('click', () => track.scrollBy({ left:  itemStep(), behavior: 'smooth' }));

    // active dot on scroll
    track.addEventListener('scroll', () => {
      const i = Math.max(0, Math.min(items.length - 1, Math.round(track.scrollLeft / itemStep())));
      dots.forEach((d, idx) => d.classList.toggle('active', idx === i));
    });
  })();
  </script>

</div>
{% endblock %}
